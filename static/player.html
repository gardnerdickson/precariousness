<head>
    <title>Precariousness!</title>

    <script type="text/javascript" src="static/common.js"></script>
    <script type="text/javascript">

        const waitingForPlayerTemplate = "<p>Waiting for ${PLAYER_NAME} to choose a tile</p>"
        const categoryButtonTemplate =
            "<li onclick=\"categoryClicked('${CATEGORY}')\" class=\"question-button\"><p>${CATEGORY}</p></li>"
        const questionButtonTemplate =
            "<li onclick=\"questionClicked('${CATEGORY}', '${QUESTION_AMOUNT}')\" class=\"question-button\"><p>${QUESTION_AMOUNT}</p></li>"
        const questionBackButtonTemplate =
            "<li onclick=\"backClicked('${CATEGORY}')\" class=\"back-button\"><p>Back</p></li>"

        let d = document

        let playerId = null
        let websocket = null

        const socketMessageRouter = new SocketMessageRouter()
        socketMessageRouter.addRoute("WAITING_FOR_PLAYER_CHOICE", handleWaitingForPlayer)
        socketMessageRouter.addRoute("PLAYER_TURN_START", handlePlayerTurnStart)

        d.addEventListener("DOMContentLoaded", () => {
            d.querySelector("#init-button").addEventListener("click", () => {
                if (websocket !== null) {
                    const playerName = d.querySelector("#name-input").value
                    const message = JSON.stringify({
                        "operation": "PLAYER_INIT",
                        "payload": {
                            "playerName": playerName
                        }
                    })
                    websocket.send(message)
                    hideScreens()
                }
            })

            d.querySelector("#buzzer").addEventListener("click", () => {
                if (websocket != null) {
                    const message = JSON.stringify({
                        "operation": "PLAYER_BUZZ",
                    })
                    websocket.send(message)
                }
            })
        })


        function showCategorySelectionButtons() {
            hideScreens()
            const chooseCategoryContainer = d.querySelector("#choose-category")
            chooseCategoryContainer.innerHTML = ""
            service.getGameBoard().then((gameState) => {
                const round = gameState.rounds[gameState.currentRound]
                for (let category of round.categories) {
                    chooseCategoryContainer.innerHTML += categoryButtonTemplate.replaceAll("${CATEGORY}", category.name)
                }
                chooseCategoryContainer.style.display = ""
            })
        }


        function categoryClicked(categoryName) {
            const message = JSON.stringify({
                "operation": "SELECT_CATEGORY",
                "payload": {
                    "category": categoryName
                }
            })
            websocket.send(message)

            hideScreens()
            const chooseQuestionContainer = d.querySelector("#choose-question")
            chooseQuestionContainer.innerHTML = ""
            service.getGameBoard().then((gameState) => {
                const category = gameState.rounds[gameState.currentRound].categories.find((value) => {
                    return value.name === categoryName
                })
                for (let amount of Object.keys(category.questions)) {
                    chooseQuestionContainer.innerHTML += questionButtonTemplate
                        .replaceAll("${QUESTION_AMOUNT}", amount)
                        .replaceAll("${CATEGORY}", categoryName)
                }
                chooseQuestionContainer.innerHTML += questionBackButtonTemplate.replaceAll("${CATEGORY}", categoryName)
                chooseQuestionContainer.style.display = ""
            })
        }


        function questionClicked(category, amount) {
            const message = JSON.stringify({
                "operation": "SELECT_QUESTION",
                "payload": {
                    "category": category,
                    "amount": amount
                }
            })
            websocket.send(message)
        }


        function backClicked(categoryName) {
            showCategorySelectionButtons()
            const message = JSON.stringify({
                "operation": "DESELECT_CATEGORY",
                "payload": {
                    "category": categoryName
                }
            })
            websocket.send(message)
        }


        function initSocket(playerId) {
            let location = window.location
            let ws_url = "ws://" + location.hostname
            if (location.port !== "") {
                ws_url += ":" + location.port
            }
            ws_url += "/player_socket/" + playerId
            console.log("Player ID is", playerId, ". Opening websocket")
            websocket = new WebSocket(ws_url)

            websocket.onopen = function (_) {
                console.log("The socket opened")
            }

            websocket.onmessage = socketMessageRouter.onmessage
        }


        function handleWaitingForPlayer(payload) {
            console.log("waiting for player", payload)
            hideScreens()
            const el = d.querySelector("#waiting-for-player")
            el.innerHTML = waitingForPlayerTemplate.replace("${PLAYER_NAME}", payload.playerName)
            el.style.display = ""
        }

        function handlePlayerTurnStart(payload) {
            console.log("PLAYER_TURN_START!!!")
            showCategorySelectionButtons()
        }


        function sendBadMessage() {
            websocket.send("adfasdfasdf")
        }


        service.newPlayer().then((response) => {
            initSocket(response.playerId)
        })

    </script>

    <link rel="stylesheet" href="static/common.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
</head>
<body>
<div id="enter-name" class="screen hideable">
    <div>
        <label for="name-input">Player name:</label><input id="name-input" type="text">
        <button id="init-button">Init</button>
    </div>
</div>
<div id="buzzer" class="screen hideable"
     style="background-color: red; position: absolute; width: 100%; height: 100%; display: none"></div>
<div id="waiting-for-player" class="screen hideable" style="display: none"></div>

<ul id="choose-category" class="screen hideable" style="display: none; padding-left: 0"></ul>
<ul id="choose-question" class="screen hideable" style="display: none; padding-left: 0"></ul>

</body>
