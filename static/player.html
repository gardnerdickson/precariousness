<head>
    <title>Precariousness</title>

    <script type="text/javascript">

        let d = document

        let playerId = null
        let websocket = null

        d.addEventListener("DOMContentLoaded", () => {
            d.querySelector("#init-button").addEventListener("click", () => {
                if (websocket !== null) {
                    const playerName = d.querySelector("#name-input").value
                    const message = JSON.stringify({
                        "operation": "PLAYER_INIT",
                        "payload": {
                            "playerName": playerName
                        }
                    })
                    websocket.send(message)
                }
            })
        })

        d.addEventListener("DOMContentLoaded", () => {
            d.querySelector("#buzz-button").addEventListener("click", () => {
                if (websocket != null) {
                    const message = JSON.stringify({
                        "operation": "PLAYER_BUZZ",
                    })
                    websocket.send(message)
                }
            })
        })

        fetch("/new_player", {method: "POST"})
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Failed to register player")
                }
                return response.json()
            })
            .then((response) => {
                playerId = response.playerId
                let location = window.location
                let ws_url = "ws://" + location.hostname
                if (location.port !== "") {
                    ws_url += ":" + location.port
                }
                ws_url += "/player_socket/" + playerId
                console.log("Player ID is", playerId, ". Opening websocket")
                websocket = new WebSocket(ws_url)

                websocket.onopen = function (_) {
                    console.log("The socket opened")
                }

                websocket.onmessage = function (event) {
                    console.log("Received message: " + event.data)
                }
            })


    </script>
</head>
<body>
<p>Player</p>
<div>
    <label for="name-input">Player name:</label><input id="name-input" type="text">
    <button id="init-button">Init</button>
</div>
<div>
    <button id="buzz-button">Buzz</button>
</div>
</body>
