<head>
    <title>Precariousness!</title>

    <script type="text/javascript" src="static/common.js"></script>
    <script type="text/javascript">

        const waitingForPlayerTemplate = "<p>Waiting for ${PLAYER_NAME} to choose a tile</p>"
        const questionButtonTemplate = "<div data-category=\"${CATEGORY}\" class=\"question-button\">${CATEGORY}</div>"

        let d = document

        let playerId = null
        let websocket = null

        const socketMessageRouter = new SocketMessageRouter()
        socketMessageRouter.addRoute("WAITING_FOR_PLAYER_CHOICE", handleWaitingForPlayer)
        socketMessageRouter.addRoute("PLAYER_TURN_START", handlePlayerTurnStart)

        d.addEventListener("DOMContentLoaded", () => {
            d.querySelector("#init-button").addEventListener("click", () => {
                if (websocket !== null) {
                    const playerName = d.querySelector("#name-input").value
                    const message = JSON.stringify({
                        "operation": "PLAYER_INIT",
                        "payload": {
                            "playerName": playerName
                        }
                    })
                    websocket.send(message)
                    hideScreens()
                }
            })

            d.querySelector("#buzzer").addEventListener("click", () => {
                if (websocket != null) {
                    const message = JSON.stringify({
                        "operation": "PLAYER_BUZZ",
                    })
                    websocket.send(message)
                }
            })
        })


        function initSocket(playerId) {
            let location = window.location
            let ws_url = "ws://" + location.hostname
            if (location.port !== "") {
                ws_url += ":" + location.port
            }
            ws_url += "/player_socket/" + playerId
            console.log("Player ID is", playerId, ". Opening websocket")
            websocket = new WebSocket(ws_url)

            websocket.onopen = function (_) {
                console.log("The socket opened")
            }

            websocket.onmessage = socketMessageRouter.onmessage
        }


        function handleWaitingForPlayer(payload) {
            console.log("waiting for player", payload)
            hideScreens()
            const el = d.querySelector("#waiting-for-player")
            el.innerHTML = waitingForPlayerTemplate.replace("${PLAYER_NAME}", payload.playerName)
            el.style.display = ""
        }

        function handlePlayerTurnStart(payload) {
            console.log("PLAYER_TURN_START!!!")
            hideScreens()

            service.getGameBoard().then((gameState) => {
                const chooseQuestionContainer = d.querySelector("#choose-question")
                const round = gameState.rounds[gameState.currentRound]
                for (let category of round.categories) {
                    chooseQuestionContainer.innerHTML += questionButtonTemplate.replaceAll("${CATEGORY}", category.name)
                }
                chooseQuestionContainer.style.display = ""
            })

        }


        function sendBadMessage() {
            websocket.send("adfasdfasdf")
        }


        service.newPlayer().then((response) => {
            initSocket(response.playerId)
        })

    </script>

    <link rel="stylesheet" href="static/common.css">
</head>
<body>
<p>Player</p>
<div id="enter-name" class="screen hideable">
    <div>
        <label for="name-input">Player name:</label><input id="name-input" type="text">
        <button id="init-button">Init</button>
    </div>
</div>
<div id="buzzer" class="screen hideable" style="background-color: red; position: absolute; width: 100%; height: 100%; display: none"></div>
<div id="waiting-for-player" class="screen hideable" style="display: none"></div>
<div id="choose-question" class="screen hideable" style="display: none;">
</div>
</body>
