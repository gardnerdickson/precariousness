<head>
    <title>Precariousness</title>

    <script type="text/javascript" src="static/common.js"></script>
    <script type="text/javascript">

        const waitingForPlayerTemplate = "<p>Waiting for ${PLAYER_NAME} to choose a tile</p>"

        let d = document

        let playerId = null
        let websocket = null

        const socketMessageRouter = new SocketMessageRouter()
        socketMessageRouter.addRoute("WAITING_FOR_PLAYER_CHOICE", handleWaitingForPlayer)
        socketMessageRouter.addRoute("PLAYER_TURN_START", handlePlayerTurnStart)

        d.addEventListener("DOMContentLoaded", () => {
            d.querySelector("#init-button").addEventListener("click", () => {
                if (websocket !== null) {
                    const playerName = d.querySelector("#name-input").value
                    const message = JSON.stringify({
                        "operation": "PLAYER_INIT",
                        "payload": {
                            "playerName": playerName
                        }
                    })
                    websocket.send(message)
                }
            })

            d.querySelector("#buzzer").addEventListener("click", () => {
                if (websocket != null) {
                    const message = JSON.stringify({
                        "operation": "PLAYER_BUZZ",
                    })
                    websocket.send(message)
                }
            })
        })


        fetch("/new_player", {method: "POST"})
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Failed to register player")
                }
                return response.json()
            })
            .then((response) => initSocket(response.playerId))


        function initSocket(playerId) {
            let location = window.location
            let ws_url = "ws://" + location.hostname
            if (location.port !== "") {
                ws_url += ":" + location.port
            }
            ws_url += "/player_socket/" + playerId
            console.log("Player ID is", playerId, ". Opening websocket")
            websocket = new WebSocket(ws_url)

            websocket.onopen = function (_) {
                console.log("The socket opened")
            }

            websocket.onmessage = socketMessageRouter.onmessage
        }


        function handleWaitingForPlayer(payload) {
            console.log("waiting for player", payload)
            hideAllGameComponents()
            const el = d.querySelector("#waiting-for-player")
            el.innerHTML = waitingForPlayerTemplate.replace("${PLAYER_NAME}", payload.playerName)
            el.style.display = ""
        }

        function handlePlayerTurnStart(payload) {
            console.log("PLAYER_TURN_START!!!")
            hideAllGameComponents()
            d.querySelector("#choose-question").style.display = ""
        }

    </script>
</head>
<body>
<p>Player</p>
<div id="enter-name" class="hideable-game-component">
    <div>
        <label for="name-input">Player name:</label><input id="name-input" type="text">
        <button id="init-button">Init</button>
    </div>
</div>
<div id="buzzer" class="hideable-game-component" style="background-color: red; position: absolute; width: 100%; height: 100%; display: none"></div>
<div id="waiting-for-player" class="hideable-game-component" style="display: none"></div>
<div id="choose-question" class="hideable-game-component" style="display: none">Choose a tile</div>
</body>
