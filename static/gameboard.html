<head>
    <title>Precariousness!</title>

    <script type="text/javascript" src="static/common.js"></script>
    <script type="text/javascript" src="static/gameboard.js"></script>
    <script type="text/javascript">

        const playerTemplate = "<div>${PLAYER_NAME} | ${PLAYER_SCORE}</div>"
        const d = document

        let socketMessageRouter = null
        let gameBoard = null


        d.addEventListener("DOMContentLoaded", () => {
            hideScreens()
            d.querySelector("#player-list-container").style.display = ""
        })


        function initSocket() {
            let location = window.location
            let ws_url = "ws://" + location.hostname
            if (location.port !== "") {
                ws_url += ":" + location.port
            }
            ws_url += "/gameboard_socket"
            console.log("Opening gameboard socket")
            socketMessageRouter = new SocketMessageRouter(ws_url)
            socketMessageRouter.addRoute("PLAYER_JOINED", handlePlayerJoined)
            socketMessageRouter.addRoute("LOAD_GAME_BOARD", handleStartGame)
            socketMessageRouter.addRoute("WAITING_FOR_PLAYER_CHOICE", handleWaitingForPlayer)
            socketMessageRouter.addRoute("CATEGORY_SELECTED", handleCategorySelected)
            socketMessageRouter.addRoute("CATEGORY_DESELECTED", handleCategoryDeselected)
            socketMessageRouter.addRoute("QUESTION_SELECTED", handleQuestionSelected)
            socketMessageRouter.addRoute("QUESTION_ANSWERED", handleQuestionAnswered)
        }


        function handlePlayerJoined(payload) {
            const playerList = d.querySelector("#player-list")
            const playerInfo = playerTemplate
                .replace("${PLAYER_NAME}", payload.playerName)
                .replace("${PLAYER_SCORE}", payload.playerScore)

            playerList.innerHTML += playerInfo
        }


        function handleStartGame(payload) {
            console.log("START GAME!!!", payload)
            hideScreens()
            const gameBoardDiv = d.querySelector("#gameboard")
            gameBoardDiv.style.display = ""
            gameBoardDiv.style.width = "100%"
            gameBoardDiv.style.height = "100%"
            gameBoardDiv.style.margin = "0"
            const gameBoardCanvas = d.querySelector("#gameboard-canvas")
            gameBoardCanvas.width = gameBoardDiv.offsetWidth
            gameBoardCanvas.height = gameBoardDiv.offsetHeight

            gameBoard = NewGameBoard(payload.gameBoard, gameBoardCanvas, onGameBoardTileStateChange)
        }


        function handleWaitingForPlayer(payload) {
            console.log("waiting for player:", payload)
        }


        function handleCategorySelected(payload) {
            console.log("handle category selected")
            gameBoard.setCategoryHighlight(payload.category)
        }


        function handleCategoryDeselected(payload) {
            gameBoard.unsetCategoryHighlight(payload.category)
        }


        function handleQuestionSelected(payload) {
            console.log("handle question selected")
            gameBoard.flickerAnswer(payload.category, payload.amount, (col, row) => {
                gameBoard.unsetCategoryHighlight(payload.category)
                gameBoard.revealAnswer(col, row)
            })
        }


        function handleQuestionAnswered(payload) {

        }


        function onGameBoardTileStateChange(round, category, amount) {
            service.markAnswerUsed(round, category, amount)
                .then(() => {
                    console.log("Mark tile used", round, category, amount)
                })
        }


        initSocket()

    </script>

    <link rel="stylesheet" href="static/common.css">
    <link rel="stylesheet" href="static/gameboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
</head>

<body>
<div id="player-list-container" class="screen hideable">
    <h4>Players</h4>
    <div id="player-list">

    </div>
</div>
<div id="waiting-for-player" class="screen hideable"></div>
<div id="gameboard" class="screen hideable">
    <canvas id="gameboard-canvas"></canvas>
</div>
</body>
