<head>
    <title>Precariousness!</title>

    <script type="text/javascript" src="static/common.js"></script>
    <script type="text/javascript">

        const waitingForPlayerTemplate = "<p>Waiting for ${PLAYER_NAME} to choose a tile</p>"
        const clueTemplate = "<p>${CLUE_TEXT}</p>"
        const playerSummaryTemplate = "<p>${PLAYER_NAME} - ${PLAYER_SCORE}</p>"
        const playerSummaryElementTemplate = "<li id=\"${PLAYER_NAME}-summary\" class=\"player-summary-item\">" +
            playerSummaryTemplate +
            "</li>"

        const d = document
        const players = new Map()

        let socketMessageRouter = null

        d.addEventListener("DOMContentLoaded", () => {
            d.querySelector("#start-game").addEventListener("click", () => {
                socketMessageRouter.sendMessage("START_GAME", {})
                initMainHostScreen()
            })
        })


        function initSocket() {
            let location = window.location
            let ws_url = "ws://" + location.hostname
            if (location.port !== "") {
                ws_url += ":" + location.port
            }
            ws_url += "/host_socket"
            console.log("Opening host socket")
            socketMessageRouter = new SocketMessageRouter(ws_url)
            socketMessageRouter.addRoute("PLAYER_JOINED", handlePlayerJoined)
            socketMessageRouter.addRoute("WAITING_FOR_PLAYER_CHOICE", handleWaitingForPlayer)
            socketMessageRouter.addRoute("CLUE_SELECTED", handleClueSelected)
            socketMessageRouter.addRoute("PLAYER_BUZZED", handlePlayerBuzzed)
            socketMessageRouter.addRoute("CLUE_ANSWERED", handleClueAnswered)
            socketMessageRouter.addRoute("PLAYER_STATE_CHANGED", handlePlayerStateChange)
        }


        function handlePlayerJoined(payload) {
            players.set(payload.playerName, payload.playerScore)
            const playerList = d.querySelector("#player-summary")
            const playerInfo = playerSummaryElementTemplate
                .replaceAll("${PLAYER_NAME}", payload.playerName)
                .replaceAll("${PLAYER_SCORE}", payload.playerScore)

            playerList.innerHTML += playerInfo
        }


        function handleWaitingForPlayer(payload) {
            console.log("START GAME!!!", payload)
            const el = d.querySelector("#waiting-for-player")
            el.style.display = ""
            el.innerHTML = waitingForPlayerTemplate.replace("${PLAYER_NAME}", payload.playerName)
        }


        function handleClueSelected(payload) {
            d.querySelector("#main").style.display = ""
            d.querySelector("#waiting-for-player").style.display = "none"
            const clueElement = d.querySelector("#clue")
            clueElement.style.display = ""
            clueElement.innerHTML = clueTemplate.replace("${CLUE_TEXT}", payload.clueText)
            d.querySelector("#response-buttons").style.display = ""
            d.querySelector("#response-correct-button").dataset.amount = payload.amount
            d.querySelector("#response-correct-button").dataset.category = payload.category
            d.querySelector("#response-incorrect-button").dataset.amount = payload.amount
            d.querySelector("#response-incorrect-button").dataset.category = payload.category
        }


        function handlePlayerBuzzed(payload) {
            const playerName = payload.playerName
            const playerSummaryItem = d.querySelector("#" + playerName + "-summary")
            playerSummaryItem.classList.add("buzzed")
            d.querySelector("#response-correct-button").dataset.playerName = playerName
            d.querySelector("#response-incorrect-button").dataset.playerName = playerName
        }


        function handleClueAnswered(payload) {
            d.querySelector("#clue").innerHTML = ""
            d.querySelector("#response-buttons").style.display = "none"
            d.querySelectorAll(".player-summary-item").forEach((item) => {
                item.classList.remove("buzzed")
            })
        }


        function handlePlayerStateChange(players) {
            for (let player of players) {
                let playerSummary = d.querySelector("#" + player.name + "-summary")
                playerSummary.innerHTML = playerSummaryTemplate
                    .replaceAll("${PLAYER_NAME}", player.name)
                    .replaceAll("${PLAYER_SCORE}", player.score)
            }
        }


        function initMainHostScreen() {
            d.querySelector("#main").style.display = ""
            d.querySelector("#start-game").style.display = "none"
        }


        function responseCorrect(buttonElement) {
            const playerName = buttonElement.dataset.playerName
            const amount = buttonElement.dataset.amount
            const category = buttonElement.dataset.category
            if ([playerName, amount, category].some(x => x === null || x === undefined)) {
                return;
            }
            socketMessageRouter.sendMessage("RESPONSE_CORRECT", {"playerName": playerName, "amount": amount, "category": category})
        }


        function responseIncorrect(buttonElement) {
            const playerName = buttonElement.dataset.playerName
            const amount = buttonElement.dataset.amount
            const category = buttonElement.dataset.category
            if ([playerName, amount, category].some(x => x === null || x === undefined)) {
                return;
            }
            socketMessageRouter.sendMessage("RESPONSE_INCORRECT", {"playerName": playerName, "amount": amount, "category": category})
        }


        initSocket()

    </script>

    <link rel="stylesheet" href="static/common.css">
</head>
<body>
<div id="waiting-for-player" class="screen hideable" style="display: none"></div>
<div id="main" class="screen hideable">
    <ul id="player-summary"></ul>
    <button id="start-game">All Players In</button>
    <div id="clue"></div>
    <div id="response-buttons" style="display: none">
        <button id="response-correct-button" onclick="responseCorrect(this)" >Correct</button>
        <button id="response-incorrect-button" onclick="responseIncorrect(this)">Incorrect</button>
    </div>
</div>
</body>
