<head>
    <title>Precariousness!</title>

    <script type="text/javascript" src="static/common.js"></script>
    <script type="text/javascript">

        const playerJoinedTemplate = "<li class=\"text-row row-label\"><p>${PLAYER_NAME}</p></li>"
        const mainTextTemplate = "<p>${TEXT}</p>"
        const playerTemplate = "<li id=\"${PLAYER_NAME}\" class=\"text-row row-label player-list-item\"><p>${PLAYER_NAME}</p></li>"

        const d = document
        const players = new Map()

        let socketMessageRouter = null
        let gameOver = false


        function initSocket() {
            let location = window.location
            let ws_url = "ws://" + location.hostname
            if (location.port !== "") {
                ws_url += ":" + location.port
            }
            ws_url += "/host_socket"
            console.log("Opening host socket")
            socketMessageRouter = new SocketMessageRouter(ws_url)
            socketMessageRouter.addRoute("PLAYER_JOINED", handlePlayerJoined)
            socketMessageRouter.addRoute("WAITING_FOR_PLAYER_CHOICE", handleWaitingForPlayer)
            socketMessageRouter.addRoute("CLUE_SELECTED", handleClueSelected)
            socketMessageRouter.addRoute("PLAYER_BUZZED", handlePlayerBuzzed)
            socketMessageRouter.addRoute("CLUE_ANSWERED", handleClueAnswered)
            socketMessageRouter.addRoute("PLAYER_STATE_CHANGED", handlePlayerStateChange)
            socketMessageRouter.addRoute("GAME_OVER", handleGameOver)
        }


        function allPlayersInClicked() {
            socketMessageRouter.sendMessage("START_GAME", {})
            initMainHostScreen()
        }


        function handlePlayerJoined(payload) {
            players.set(payload.playerName, payload.playerScore)
            const playersJoining = d.querySelector("#players-joining")
            playersJoining.innerHTML = playerJoinedTemplate.replaceAll("${PLAYER_NAME}", payload.playerName) + playersJoining.innerHTML
        }


        function handleWaitingForPlayer(payload) {
            if (gameOver) return
            const textElement = d.querySelector("#main-text")
            textElement.style.display = ""
            textElement.innerHTML = mainTextTemplate.replace("${TEXT}", "Waiting for " + payload.playerName + " to choose a clue.")
        }


        function handleClueSelected(payload) {
            d.querySelector("#main").style.display = ""
            const textElement = d.querySelector("#main-text")
            textElement.style.display = ""
            textElement.innerHTML = mainTextTemplate.replace("${TEXT}", "CLUE:<br/>" + payload.clueText)
            d.querySelector("#response-buttons").style.display = ""
            d.querySelector("#response-correct-button").dataset.amount = payload.amount
            d.querySelector("#response-correct-button").dataset.category = payload.category
            d.querySelector("#response-incorrect-button").dataset.amount = payload.amount
            d.querySelector("#response-incorrect-button").dataset.category = payload.category
        }


        function handlePlayerBuzzed(payload) {
            const playerName = payload.playerName
            const playerSummaryItem = d.querySelector("#" + playerName)
            playerSummaryItem.classList.add("buzzed")
            d.querySelector("#response-correct-button").dataset.playerName = playerName
            d.querySelector("#response-incorrect-button").dataset.playerName = playerName
        }


        function handleClueAnswered(payload) {
            const textElement = d.querySelector("#main-text")
            textElement.style.display = "none"
            textElement.innerHTML = ""
            d.querySelector("#response-buttons").style.display = "none"
            d.querySelectorAll(".player-list-item").forEach((item) => {
                item.classList.remove("buzzed")
            })
        }


        function handlePlayerStateChange(players) {
        }


        function initMainHostScreen() {
            hideScreens()
            const main = d.querySelector("#main")
            const playerList = d.querySelector("#player-list")
            players.forEach((_, name) => {
                playerList.innerHTML += playerTemplate.replaceAll("${PLAYER_NAME}", name)
            })
            main.style.display = ""
        }


        function responseCorrect(buttonElement) {
            const playerName = buttonElement.dataset.playerName
            const amount = buttonElement.dataset.amount
            const category = buttonElement.dataset.category
            if ([playerName, amount, category].some(x => x === null || x === undefined)) {
                return;
            }
            socketMessageRouter.sendMessage("RESPONSE_CORRECT", {"playerName": playerName, "amount": amount, "category": category})
        }


        function responseIncorrect(buttonElement) {
            const playerName = buttonElement.dataset.playerName
            const amount = buttonElement.dataset.amount
            const category = buttonElement.dataset.category
            if ([playerName, amount, category].some(x => x === null || x === undefined)) {
                return;
            }
            socketMessageRouter.sendMessage("RESPONSE_INCORRECT", {"playerName": playerName, "amount": amount, "category": category})
        }


        function handleGameOver(_) {
            hideScreens()
            gameOver = true
        }


        initSocket()

    </script>

    <link rel="stylesheet" href="static/common.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Angkor&display=swap" rel="stylesheet">

</head>
<body>
<ul id="players-joining" class="screen hideable">
    <li class="text-row row-button" onclick="allPlayersInClicked()"><p>All Players In</p></li>
</ul>
<div id="main" class="screen hideable">
    <div id="main-text" class="text-row row-label" style="display: none"></div>
    <ul id="player-list"></ul>
    <ul id="response-buttons" style="display: none;">
        <li id="response-correct-button" class="text-column row-button" onclick="responseCorrect(this)"><p>Correct</p></li>
        <li id="response-incorrect-button" class="text-column row-button" onclick="responseIncorrect(this)"><p>Incorrect</p></li>
    </ul>
</div>
</body>
